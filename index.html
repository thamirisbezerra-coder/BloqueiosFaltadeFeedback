import React, { useState, useMemo, useEffect } from 'react';
import { Lock, Unlock, Search, AlertTriangle, User, BarChart3, ArrowUpDown, CheckCircle, XCircle, Send, Layers, Filter, Settings, Save, X, LogIn } from 'lucide-react';

// Dados iniciais (usados se não houver nada salvo)
const INITIAL_DATA = [
  { name: "ALEXANDRE NASCIMENTO", segment: "SMB", pending: 0, answered: 29, total: 29 },
  { name: "ALEXSANDER DE ANDRADE OLIVEIRA", segment: "SORVETES", pending: 0, answered: 39, total: 39 },
  { name: "ALINE BARROS", segment: "NUTRICAO ANIMAL", pending: 33, answered: 0, total: 33 },
  { name: "ALISSON FERNANDES", segment: "LACTEOS", pending: 0, answered: 197, total: 197 },
  { name: "ANA MOTA", segment: "SORVETES", pending: 0, answered: 63, total: 63 },
  { name: "ANDRÉ BRESSANIN", segment: "SORVETES", pending: 0, answered: 129, total: 129 },
  { name: "ANDRE FELIX", segment: "SORVETES", pending: 61, answered: 62, total: 123 },
  { name: "ANDREIA TINTI", segment: "NUTRACEUTICOS", pending: 0, answered: 148, total: 148 },
  { name: "ANTENOR ADRIANO", segment: "SORVETES", pending: 0, answered: 114, total: 114 },
  { name: "BRUNO VERONEZ", segment: "SMB", pending: 0, answered: 562, total: 562 },
  { name: "CAMILA BENTO", segment: "LACTEOS", pending: 0, answered: 27, total: 27 },
  { name: "CLAUDIANO TERCARIOL", segment: "SORVETES", pending: 17, answered: 16, total: 33 },
  { name: "CRISTIANE OLIVEIRA", segment: "LACTEOS", pending: 2, answered: 7, total: 9 },
  { name: "CRISTIANO RAMOS", segment: "CÁRNEOS", pending: 0, answered: 123, total: 123 },
  { name: "DANIELA MARCHEZIN", segment: "SORVETES", pending: 0, answered: 57, total: 57 },
  { name: "DANILO ARAUJO", segment: "SORVETES", pending: 0, answered: 40, total: 40 },
  { name: "DANILO TREMOCOLDI", segment: "NUTRICAO ANIMAL", pending: 0, answered: 66, total: 66 },
  { name: "DELMAR PAES", segment: "SORVETES", pending: 38, answered: 91, total: 129 },
  { name: "DIEGO FIORIO", segment: "SORVETES", pending: 0, answered: 90, total: 90 },
  { name: "DIRETO - FISCAL", segment: "Sem Segmento", pending: 0, answered: 3, total: 3 },
  { name: "DIRETO - JMC", segment: "Sem Segmento", pending: 5, answered: 0, total: 5 },
  { name: "DIRETO- MACALE", segment: "LACTEOS", pending: 2, answered: 0, total: 2 },
  { name: "DIRETO-DANTE", segment: "LACTEOS", pending: 0, answered: 51, total: 51 },
  { name: "DOUGLAS SILVA", segment: "SORVETES", pending: 0, answered: 111, total: 111 },
  { name: "ELINIVAL SANTOS", segment: "SMB", pending: 68, answered: 0, total: 68 },
  { name: "EUCLEBIO SOUZA", segment: "SORVETES", pending: 0, answered: 20, total: 20 },
  { name: "FABRICIO NOGUEIRA", segment: "LACTEOS", pending: 0, answered: 47, total: 47 },
  { name: "FABRICIO OLIVEIRA DE CARVALHO", segment: "SORVETES", pending: 0, answered: 13, total: 13 },
  { name: "FELIPE LOHAN", segment: "LACTEOS", pending: 0, answered: 106, total: 106 },
  { name: "FELIPE LOPES BARBOSA", segment: "SORVETES", pending: 0, answered: 39, total: 39 },
  { name: "FERNANDA BEATRIZ", segment: "NUTRACEUTICOS", pending: 0, answered: 54, total: 54 },
  { name: "FERNANDA CAMPOS", segment: "PANIFICACAO", pending: 1, answered: 0, total: 1 },
  { name: "FLAVIO BORTOLINI", segment: "EXPORTACAO", pending: 0, answered: 268, total: 268 },
  { name: "FRANCISCO ALVES FERREIRA", segment: "SORVETES", pending: 20, answered: 0, total: 20 },
  { name: "GABRIEL PAZIANOTO", segment: "SORVETES", pending: 0, answered: 49, total: 49 },
  { name: "GEORGIA ARAUJO", segment: "SORVETES", pending: 0, answered: 66, total: 66 },
  { name: "GILBERTO JUNIOR", segment: "PANIFICACAO", pending: 0, answered: 76, total: 76 },
  { name: "GUILHERME ANTONIO", segment: "SORVETES", pending: 135, answered: 0, total: 135 },
  { name: "GUILHERME SILVA", segment: "SMB", pending: 106, answered: 45, total: 151 },
  { name: "GUSTAVO BONFIM", segment: "SMB", pending: 0, answered: 7, total: 7 },
  { name: "GUSTAVO MAIA", segment: "NUTRICAO ANIMAL", pending: 8, answered: 0, total: 8 },
  { name: "IGOR CROVATO", segment: "LACTEOS", pending: 0, answered: 149, total: 149 },
  { name: "JACKSON DE ALMEIDA FREITAS", segment: "SORVETES", pending: 0, answered: 32, total: 32 },
  { name: "JOAO SCHITTKOWSKI", segment: "NUTRACEUTICOS", pending: 0, answered: 151, total: 151 },
  { name: "JULIANA LAGUNA", segment: "PANIFICACAO", pending: 0, answered: 101, total: 101 },
  { name: "JURACI TALASCA", segment: "CÁRNEOS", pending: 0, answered: 76, total: 76 },
  { name: "KARLA ALMEIDA", segment: "NUTRACEUTICOS", pending: 98, answered: 0, total: 98 },
  { name: "LEANDRO FENALTI", segment: "PANIFICACAO", pending: 0, answered: 67, total: 67 },
  { name: "LEANDRO GASPARINI", segment: "PANIFICACAO", pending: 0, answered: 133, total: 133 },
  { name: "LEILA RODRIGUES", segment: "PANIFICACAO", pending: 0, answered: 96, total: 96 },
  { name: "LEONARDO GARCIA", segment: "CÁRNEOS", pending: 0, answered: 158, total: 158 },
  { name: "LEONARDO SODRE", segment: "CÁRNEOS", pending: 0, answered: 52, total: 52 },
  { name: "LUCIMARIO BEZERRA DA SILVA", segment: "SORVETES", pending: 0, answered: 40, total: 40 },
  { name: "LUIS ADRIANO", segment: "CÁRNEOS", pending: 0, answered: 6, total: 6 },
  { name: "LUIS FELIPE CASSA", segment: "SORVETES", pending: 0, answered: 89, total: 89 },
  { name: "LUIS SCARPIN", segment: "FOOD SERVICE", pending: 0, answered: 114, total: 114 },
  { name: "LUIZ FELIPE", segment: "SORVETES", pending: 5, answered: 67, total: 72 },
  { name: "MAICON SILVA", segment: "SORVETES", pending: 21, answered: 67, total: 88 },
  { name: "MARCELO COSTA", segment: "LACTEOS", pending: 0, answered: 34, total: 34 },
  { name: "MARCO ANTONIO", segment: "SORVETES", pending: 87, answered: 0, total: 87 },
  { name: "MARCUS MASCARENHAS", segment: "SORVETES", pending: 0, answered: 67, total: 67 },
  { name: "MARIANA CONEGERO", segment: "EXPORTACAO", pending: 59, answered: 0, total: 59 },
  { name: "MARINA POSSEBON", segment: "CÁRNEOS", pending: 0, answered: 94, total: 94 },
  { name: "MARIO GUERRERO", segment: "EXPORTACAO", pending: 264, answered: 211, total: 475 },
  { name: "MARISTELA THOMAZINI", segment: "PANIFICACAO", pending: 90, answered: 0, total: 90 },
  { name: "MARITZA TEIXEIRA", segment: "PANIFICACAO", pending: 0, answered: 62, total: 62 },
  { name: "MARTIN SCHWARZ", segment: "SORVETES", pending: 0, answered: 177, total: 177 },
  { name: "MELINA MUFFO RUZZI", segment: "SORVETES", pending: 0, answered: 107, total: 107 },
  { name: "MORLEY RAMALHO", segment: "SMB", pending: 0, answered: 114, total: 114 },
  { name: "NATA ZAFENATE", segment: "SORVETES", pending: 0, answered: 91, total: 91 },
  { name: "PATRICIA ALVES PINATTI", segment: "SMB", pending: 0, answered: 188, total: 188 },
  { name: "PATRICIA CORREIA", segment: "NUTRACEUTICOS", pending: 0, answered: 103, total: 103 },
  { name: "PAULO BARRETO", segment: "SORVETES", pending: 0, answered: 88, total: 88 },
  { name: "PEDRO DE OLIVEIRA SILVA", segment: "SORVETES", pending: 0, answered: 112, total: 112 },
  { name: "PEDRO LESSA", segment: "SORVETES", pending: 7, answered: 41, total: 48 },
  { name: "RENATO VASCONCELOS", segment: "SMB", pending: 0, answered: 112, total: 112 },
  { name: "RESÍDUOS / INATIVOS - CÁRNEOS", segment: "Sem Segmento", pending: 0, answered: 1, total: 1 },
  { name: "RESÍDUOS / INATIVOS - EXPORTAÇÃO", segment: "Sem Segmento", pending: 0, answered: 1, total: 1 },
  { name: "RICARDO BUKALIL", segment: "SORVETES", pending: 86, answered: 0, total: 86 },
  { name: "SAULO NÁCLE PEREIRA", segment: "SORVETES", pending: 0, answered: 23, total: 23 },
  { name: "SERGIO VIEIRA", segment: "NUTRACEUTICOS", pending: 0, answered: 55, total: 55 },
  { name: "SIDNEI RODRIGUES", segment: "NUTRACEUTICOS", pending: 0, answered: 113, total: 113 },
  { name: "TATIANE LOURENCO", segment: "NUTRACEUTICOS", pending: 0, answered: 105, total: 105 },
  { name: "VAGA - ALEX OLIVEIRA", segment: "LACTEOS", pending: 0, answered: 8, total: 8 },
  { name: "VAGA - ANA FLAVIA AMAMOTO", segment: "SMB", pending: 22, answered: 0, total: 22 },
  { name: "VAGA - ED CARLOS RIBEIRO SANTANA", segment: "CÁRNEOS", pending: 157, answered: 0, total: 157 },
  { name: "VAGA - INATIVADOS", segment: "Sem Segmento", pending: 0, answered: 1, total: 1 },
  { name: "VAGA - LINCOLN VIANNA", segment: "SMB", pending: 7, answered: 0, total: 7 },
  { name: "VAGA - LUCIANA ALVES", segment: "PANIFICACAO", pending: 40, answered: 0, total: 40 },
  { name: "VAGA - MARCELO DE SOUSA REIS", segment: "SORVETES", pending: 0, answered: 20, total: 20 },
  { name: "VICTOR ROSSI", segment: "NUTRACEUTICOS", pending: 0, answered: 127, total: 127 },
  { name: "VINICIUS REGINATO", segment: "SMB", pending: 0, answered: 116, total: 116 },
  { name: "VINICIUS SILVA", segment: "SMB", pending: 0, answered: 220, total: 220 },
  { name: "VITOR DINIZ", segment: "SORVETES", pending: 33, answered: 0, total: 33 },
  { name: "VITOR VINAS DUTRA", segment: "SORVETES", pending: 0, answered: 169, total: 169 },
  { name: "WASHINGTON DIAS", segment: "CÁRNEOS", pending: 0, answered: 113, total: 113 },
  { name: "WILSON LUCENA", segment: "SORVETES", pending: 20, answered: 0, total: 20 },
];

export default function FeedbackBlockScreen() {
  // Inicializa estado com localStorage ou dados iniciais
  const [users, setUsers] = useState(() => {
    const saved = localStorage.getItem('feedbackData');
    if (saved) {
      try {
        return JSON.parse(saved);
      } catch (e) {
        return INITIAL_DATA;
      }
    }
    return INITIAL_DATA;
  });

  const [searchTerm, setSearchTerm] = useState("");
  const [selectedSegment, setSelectedSegment] = useState("Todos");
  const [sortConfig, setSortConfig] = useState({ key: 'pending', direction: 'desc' });
  const [selectedUser, setSelectedUser] = useState(null);
  
  // Estados para Admin/Login
  const [isAdmin, setIsAdmin] = useState(false);
  const [isLoginOpen, setIsLoginOpen] = useState(false);
  const [passwordInput, setPasswordInput] = useState("");
  const [loginError, setLoginError] = useState("");

  // Salva no localStorage sempre que users mudar
  useEffect(() => {
    localStorage.setItem('feedbackData', JSON.stringify(users));
  }, [users]);

  // Extrair lista única de segmentos
  const segments = useMemo(() => {
    const uniqueSegments = [...new Set(users.map(u => u.segment))].sort();
    return ["Todos", ...uniqueSegments];
  }, [users]);

  // Lógica de Ordenação e Filtro
  const filteredUsers = useMemo(() => {
    let sortedUsers = [...users];

    if (sortConfig.key) {
      sortedUsers.sort((a, b) => {
        if (a[sortConfig.key] < b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key] > b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }

    return sortedUsers.filter(user => {
      const matchesSearch = user.name.toLowerCase().includes(searchTerm.toLowerCase());
      const matchesSegment = selectedSegment === "Todos" || user.segment === selectedSegment;
      return matchesSearch && matchesSegment;
    });
  }, [users, sortConfig, searchTerm, selectedSegment]);

  // Stats Dinâmicos (baseados no filtro atual)
  const dynamicStats = useMemo(() => {
    const totalPending = filteredUsers.reduce((acc, curr) => acc + curr.pending, 0);
    const totalPeople = filteredUsers.length;
    const blockedPeople = filteredUsers.filter(u => u.pending > 0).length;
    return { totalPending, totalPeople, blockedPeople };
  }, [filteredUsers]);

  const requestSort = (key) => {
    let direction = 'desc';
    if (sortConfig.key === key && sortConfig.direction === 'desc') {
      direction = 'asc';
    }
    setSortConfig({ key, direction });
  };

  // Funções de Admin
  const handleLogin = (e) => {
    e.preventDefault();
    if (passwordInput === "admin") {
      setIsAdmin(true);
      setIsLoginOpen(false);
      setPasswordInput("");
      setLoginError("");
    } else {
      setLoginError("Senha incorreta");
    }
  };

  const handleUpdateUser = (indexInList, field, value) => {
    // Encontrar o usuário original no array principal 'users'
    // filteredUsers é apenas uma view, precisamos atualizar o state 'users'
    const userToUpdate = filteredUsers[indexInList];
    
    const updatedUsers = users.map(u => {
      if (u.name === userToUpdate.name) {
        return { ...u, [field]: Number(value) };
      }
      return u;
    });
    setUsers(updatedUsers);
  };

  // Modal de Login
  const LoginModal = () => (
    <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
      <div className="bg-white w-full max-w-md rounded-2xl shadow-xl p-6">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
            <Settings className="w-5 h-5" /> Área Administrativa
          </h2>
          <button onClick={() => setIsLoginOpen(false)} className="p-1 hover:bg-slate-100 rounded-full">
            <X className="w-5 h-5 text-slate-500" />
          </button>
        </div>
        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">Senha de Acesso</label>
            <input 
              type="password" 
              value={passwordInput}
              onChange={(e) => setPasswordInput(e.target.value)}
              className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
              placeholder="Digite a senha..."
              autoFocus
            />
            {loginError && <p className="text-red-500 text-sm mt-1">{loginError}</p>}
          </div>
          <div className="flex justify-end gap-2">
            <button type="button" onClick={() => setIsLoginOpen(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium">Cancelar</button>
            <button type="submit" className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Entrar</button>
          </div>
        </form>
      </div>
    </div>
  );

  // Componente de Simulação de Tela Bloqueada
  const LockModal = ({ user, onClose }) => {
    if (!user) return null;
    const isBlocked = user.pending > 0;

    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/95 backdrop-blur-sm p-4 animate-in fade-in duration-300">
        <div className={`bg-zinc-900 border ${isBlocked ? 'border-red-600/50' : 'border-green-500/50'} w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col relative`}>
          <div className={`${isBlocked ? 'bg-red-600/20 border-red-600/30' : 'bg-green-600/20 border-green-600/30'} p-8 flex flex-col items-center justify-center border-b`}>
            {isBlocked ? (
              <Lock className="w-20 h-20 text-red-500 mb-4 animate-pulse" />
            ) : (
              <CheckCircle className="w-20 h-20 text-green-500 mb-4" />
            )}
            <h2 className="text-3xl font-bold text-white tracking-tight">
              {isBlocked ? 'ACESSO BLOQUEADO' : 'TUDO CERTO!'}
            </h2>
            <p className={`${isBlocked ? 'text-red-200' : 'text-green-200'} mt-2 text-center`}>
              {isBlocked 
                ? 'O sistema aguarda ações pendentes para liberar seu acesso.'
                : 'Você não possui pendências. Acesso liberado.'}
            </p>
            <div className="mt-4 px-4 py-1 bg-black/30 rounded-full border border-white/10 text-sm text-white/70 font-medium">
              {user.segment}
            </div>
          </div>

          <div className="p-8 flex flex-col items-center">
            <h3 className="text-2xl text-white font-semibold mb-2 text-center">{user.name}</h3>
            <div className="flex items-center gap-4 mb-8 mt-4">
               <div className="text-center p-4 bg-zinc-800 rounded-lg border border-zinc-700">
                 <span className={`block text-4xl font-bold ${isBlocked ? 'text-red-500' : 'text-green-500'}`}>{user.pending}</span>
                 <span className="text-xs text-gray-400 uppercase tracking-wider">Pendências</span>
               </div>
            </div>
            
            <div className="w-full bg-zinc-800 h-4 rounded-full overflow-hidden mb-2">
              <div 
                className={`h-full transition-all duration-500 ${isBlocked ? 'bg-gradient-to-r from-red-600 to-orange-600' : 'bg-green-500'}`}
                style={{ width: user.total > 0 ? `${(user.answered / user.total) * 100}%` : '0%' }}
              />
            </div>
            <p className="text-zinc-500 text-sm mb-8 text-center w-full">
              Progresso: {user.answered} de {user.total} realizados ({user.total > 0 ? Math.round((user.answered/user.total)*100) : 0}%)
            </p>

            <button 
              onClick={onClose}
              className="px-6 py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-lg border border-zinc-700 transition-colors flex items-center gap-2 group"
            >
              <Unlock className="w-4 h-4 group-hover:text-green-400 transition-colors" />
              <span>{isBlocked ? 'Modo Administrador: Liberar Temporariamente' : 'Fechar Janela'}</span>
            </button>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans">
      {isLoginOpen && <LoginModal />}
      {selectedUser && <LockModal user={selectedUser} onClose={() => setSelectedUser(null)} />}

      <header className="bg-slate-900 text-white shadow-lg sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex flex-col md:flex-row justify-between items-center gap-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-red-600 rounded-lg shadow-red-900/50 shadow-lg">
                <Lock className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-xl font-bold tracking-tight">Painel de Feedback</h1>
                <p className="text-slate-400 text-xs">Monitoramento e Bloqueio</p>
              </div>
            </div>

            <div className="flex items-center gap-4">
               {/* Stats Dinâmicos baseados no filtro */}
               <div className="flex gap-3 text-center">
                  <div className="bg-slate-800/50 px-4 py-1.5 rounded-lg border border-slate-700/50 backdrop-blur">
                    <span className="block text-xl font-bold text-red-400">{dynamicStats.totalPending}</span>
                    <span className="text-[10px] text-slate-400 uppercase">Pendências</span>
                  </div>
                  <div className="bg-slate-800/50 px-4 py-1.5 rounded-lg border border-slate-700/50 backdrop-blur hidden sm:block">
                     <span className="block text-xl font-bold text-orange-400">{dynamicStats.blockedPeople}</span>
                     <span className="text-[10px] text-slate-400 uppercase">Bloqueados</span>
                  </div>
               </div>

               {/* Botão Admin */}
               <button 
                 onClick={() => isAdmin ? setIsAdmin(false) : setIsLoginOpen(true)}
                 className={`p-2 rounded-lg transition-colors border ${isAdmin ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:text-white'}`}
                 title={isAdmin ? "Sair do Modo Admin" : "Área Administrativa"}
               >
                 {isAdmin ? <Save className="w-5 h-5" /> : <Settings className="w-5 h-5" />}
               </button>
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-6">
        
        {/* Aviso de Modo Admin */}
        {isAdmin && (
          <div className="mb-6 bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg flex items-center justify-between animate-in slide-in-from-top-2">
            <div className="flex items-center gap-3">
              <Settings className="w-5 h-5 text-blue-600" />
              <div>
                <p className="text-sm font-bold text-blue-800">Modo de Edição Ativo</p>
                <p className="text-xs text-blue-600">Você pode alterar as pendências e respostas diretamente nos cartões abaixo.</p>
              </div>
            </div>
            <button onClick={() => setIsAdmin(false)} className="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full hover:bg-blue-200 transition-colors font-medium">
              Salvar e Sair
            </button>
          </div>
        )}

        {/* Segment Filter Bar */}
        <div className="mb-6 overflow-x-auto pb-2 hide-scrollbar">
          <div className="flex gap-2 min-w-max">
            {segments.map(seg => (
              <button
                key={seg}
                onClick={() => setSelectedSegment(seg)}
                className={`
                  px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap flex items-center gap-2
                  ${selectedSegment === seg 
                    ? 'bg-slate-800 text-white shadow-md ring-2 ring-slate-800 ring-offset-2' 
                    : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:border-slate-300'}
                `}
              >
               {seg === "Todos" && <Layers className="w-3 h-3" />}
               {seg}
               {seg !== "Todos" && (
                 <span className={`text-[10px] ml-1 px-1.5 py-0.5 rounded-full ${selectedSegment === seg ? 'bg-slate-600 text-white' : 'bg-slate-100 text-slate-500'}`}>
                   {users.filter(u => u.segment === seg).length}
                 </span>
               )}
              </button>
            ))}
          </div>
        </div>

        {/* Resumo do Segmento (Aparece apenas se um segmento específico for selecionado) */}
        {selectedSegment !== "Todos" && (
           <div className="mb-6 flex items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm animate-in fade-in">
              <div className="p-3 bg-slate-100 rounded-full">
                 <Filter className="w-6 h-6 text-slate-600" />
              </div>
              <div>
                 <h3 className="font-bold text-slate-800 text-lg">Resumo: {selectedSegment}</h3>
                 <div className="flex gap-4 text-sm text-slate-500">
                    <span><strong>{dynamicStats.totalPending}</strong> pendências totais</span>
                    <span className="w-1 h-1 rounded-full bg-slate-300 self-center"></span>
                    <span><strong>{dynamicStats.totalPeople}</strong> colaboradores</span>
                 </div>
              </div>
           </div>
        )}

        {/* Controles de Busca */}
        <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
          <div className="relative w-full md:w-96">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
            <input
              type="text"
              placeholder="Buscar colaborador..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>
          
          <div className="flex gap-2 w-full md:w-auto justify-end">
            <button 
              onClick={() => requestSort('name')}
              className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${sortConfig.key === 'name' ? 'bg-blue-100 text-blue-700' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}
            >
              <ArrowUpDown className="w-4 h-4" /> Nome
            </button>
            <button 
              onClick={() => requestSort('pending')}
              className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ${sortConfig.key === 'pending' ? 'bg-red-100 text-red-700' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}
            >
              <ArrowUpDown className="w-4 h-4" /> Pendências
            </button>
          </div>
        </div>

        {/* Grid de Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredUsers.map((user, index) => {
            const percent = user.total > 0 ? (user.answered / user.total) * 100 : 0;
            const isBlocked = user.pending > 0;
            const isCritical = user.pending > 50;
            
            return (
              <div 
                key={user.name} 
                className={`
                  relative bg-white rounded-xl shadow-sm border transition-all duration-200 group overflow-hidden
                  ${isAdmin ? 'ring-2 ring-blue-500/20 border-blue-200' : 'hover:shadow-md hover:-translate-y-1 cursor-pointer'}
                  ${!isAdmin && (isBlocked ? (isCritical ? 'border-red-200' : 'border-slate-200') : 'border-green-200')}
                `}
                onClick={() => !isAdmin && setSelectedUser(user)}
              >
                {/* Status Bar Top */}
                <div className={`h-1.5 w-full ${isBlocked ? (isCritical ? 'bg-red-500' : 'bg-orange-400') : 'bg-green-500'}`} />
                
                <div className="p-6">
                  <div className="flex justify-between items-start mb-4">
                    <div className="flex items-center gap-3 overflow-hidden">
                      <div className={`w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center ${isBlocked ? (isCritical ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-600') : 'bg-green-100 text-green-600'}`}>
                        <User className="w-5 h-5" />
                      </div>
                      <div className="min-w-0">
                        <h3 className="font-bold text-slate-800 text-sm leading-tight truncate pr-2" title={user.name}>{user.name}</h3>
                        <div className="flex items-center gap-2 mt-1">
                            <span className={`text-[10px] px-1.5 py-0.5 rounded font-semibold uppercase tracking-wider truncate ${isBlocked ? 'bg-slate-100 text-slate-500' : 'bg-green-50 text-green-600'}`}>
                                {user.segment}
                            </span>
                        </div>
                      </div>
                    </div>
                    {!isAdmin && (
                      isBlocked ? (
                          <Lock className={`w-5 h-5 flex-shrink-0 ${isCritical ? 'text-red-500' : 'text-orange-400'}`} />
                      ) : (
                          <CheckCircle className="w-5 h-5 flex-shrink-0 text-green-500" />
                      )
                    )}
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-4">
                    {/* Box de Pendentes (Editável se Admin) */}
                    <div className={`bg-slate-50 p-3 rounded-lg border ${isBlocked ? 'border-slate-100' : 'border-green-100 bg-green-50/50'} text-center relative`}>
                      {isAdmin ? (
                        <input 
                          type="number"
                          value={user.pending}
                          onChange={(e) => handleUpdateUser(index, 'pending', e.target.value)}
                          onClick={(e) => e.stopPropagation()}
                          className="w-full bg-white border border-blue-300 rounded px-1 text-center font-bold text-xl text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                      ) : (
                        <span className={`block text-2xl font-bold ${isBlocked ? (isCritical ? 'text-red-600' : 'text-slate-700') : 'text-green-600'}`}>
                          {user.pending}
                        </span>
                      )}
                      <span className="text-[10px] text-slate-400 uppercase font-bold tracking-wider block mt-1">Pendentes</span>
                    </div>

                    {/* Box de Respondidos (Editável se Admin) */}
                    <div className="bg-slate-50 p-3 rounded-lg border border-slate-100 text-center relative">
                      {isAdmin ? (
                         <input 
                           type="number"
                           value={user.answered}
                           onChange={(e) => handleUpdateUser(index, 'answered', e.target.value)}
                           onClick={(e) => e.stopPropagation()}
                           className="w-full bg-white border border-blue-300 rounded px-1 text-center font-bold text-xl text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none"
                         />
                      ) : (
                        <span className="block text-2xl font-bold text-slate-700">
                          {isAdmin ? user.answered : Math.round(percent) + '%'}
                        </span>
                      )}
                      <span className="text-[10px] text-slate-400 uppercase font-bold tracking-wider block mt-1">
                        {isAdmin ? 'Respondidos' : 'Concluído'}
                      </span>
                    </div>
                  </div>

                  <div className="space-y-1">
                    <div className="flex justify-between text-xs text-slate-500">
                      <span>Progresso</span>
                      <span>{user.answered} / {user.total}</span>
                    </div>
                    <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                      <div 
                        className={`h-full rounded-full transition-all duration-500 ${isBlocked ? (isCritical ? 'bg-red-500' : 'bg-blue-500') : 'bg-green-500'}`}
                        style={{ width: `${percent}%` }}
                      />
                    </div>
                  </div>
                  
                  {/* Overlay de Hover (Apenas se não for Admin) */}
                  {!isAdmin && (
                    <div className="absolute inset-0 bg-slate-900/0 group-hover:bg-slate-900/5 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100">
                      <span className="bg-white px-4 py-2 rounded-full shadow-lg text-xs font-bold text-slate-700 flex items-center gap-2">
                        {isBlocked ? <Lock className="w-3 h-3" /> : <CheckCircle className="w-3 h-3 text-green-500" />} 
                        {isBlocked ? 'Simular Tela' : 'Ver Status'}
                      </span>
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>

        {filteredUsers.length === 0 && (
            <div className="text-center py-20">
                <div className="bg-slate-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Filter className="w-8 h-8 text-slate-400" />
                </div>
                <h3 className="text-slate-600 font-medium">Nenhum resultado encontrado</h3>
                <p className="text-slate-400 text-sm">Tente ajustar os filtros ou a busca.</p>
                <button 
                    onClick={() => {setSearchTerm(""); setSelectedSegment("Todos");}}
                    className="mt-4 text-blue-600 hover:text-blue-700 text-sm font-medium"
                >
                    Limpar filtros
                </button>
            </div>
        )}
      </main>
    </div>
  );
}